<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒéŸ³å­—å¤§ä½œæˆ° - æ˜Ÿéš›æˆ°çˆ­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- å­—é«”è¨­å®š --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: "KaiTi", "BiauKai", "DFKai-SB", "TW-Kai", "Noto Serif TC", serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            background-color: #000;
            perspective: 1000px;
        }

        /* --- èƒŒæ™¯å„ªåŒ–ï¼šæ˜Ÿéš›ç©¿æ¢­ (Warp Speed) --- */
        .starfield {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #0f172a 0%, #000000 100%);
            overflow: hidden;
        }

        .stars {
            position: absolute;
            top: 50%; left: 50%;
            width: 2px; height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 
                -400px -300px white, 300px -200px white, -200px 300px white, 
                150px -350px white, -350px 200px white, 200px 100px white,
                -100px -200px white, 300px 300px white, -50px -50px white,
                400px -100px white, -300px 400px white, 100px 250px white,
                -250px -150px white, 250px -300px white, -150px 150px white;
            animation: fly 30s linear infinite;
            transform-origin: center;
        }
        
        .stars:nth-child(2) {
            width: 3px; height: 3px;
            animation: fly 20s linear infinite;
            opacity: 0.7;
            box-shadow: 
                -300px -200px #63b3ed, 200px -100px #63b3ed, -100px 200px #63b3ed, 
                100px -250px #63b3ed, -250px 100px #63b3ed, 150px 50px #63b3ed;
        }
        
        .stars:nth-child(3) {
            width: 1px; height: 1px;
            animation: fly 40s linear infinite;
            opacity: 0.5;
        }

        @keyframes fly {
            from { transform: translate(-50%, -50%) rotate(0deg) scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            to { transform: translate(-50%, -50%) rotate(20deg) scale(3); opacity: 0; }
        }

        /* --- æ ¸å¿ƒçµ„ä»¶ï¼šç”Ÿå­—å¡ --- */
        .char-card {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 0 15px rgba(66, 153, 225, 0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            border: 3px solid #2b6cb0;
            position: relative;
            overflow: hidden;
        }

        .char-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), transparent);
            opacity: 0.3;
            pointer-events: none;
        }

        .char-card:active {
            transform: scale(0.95);
            background-color: #cbd5e0;
            box-shadow: 0 0 5px rgba(66, 153, 225, 0.8);
        }

        .hanzi {
            font-size: 2.8rem;
            line-height: 1;
            color: #1a202c;
            font-weight: 900;
            margin-right: 4px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }

        /* --- æ³¨éŸ³å®¹å™¨ --- */
        .zhuyin-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-left: 4px;
            padding-left: 6px;
            border-left: 2px dashed #4a5568;
            height: 3rem;
        }

        .bpmf-symbol {
            font-family: "BiauKai", "KaiTi", serif;
            font-size: 0.9rem;
            line-height: 1;
            color: #2d3748;
            font-weight: bold;
            position: relative;
            height: 1em;
            width: 1em;
            text-align: center;
        }

        .tone-mark {
            position: absolute;
            right: -0.55em;    
            top: -0.25em;      
            font-size: 1.1em;  
            font-weight: 900;  
            line-height: 1;
            transform: scale(1.1, 1.4); 
            transform-origin: center;
        }

        .tone-neutral {
            font-family: "BiauKai", "KaiTi", serif;
            font-size: 0.8rem;
            margin-bottom: -4px;
            color: #2d3748;
            font-weight: 900;
            transform: scale(1.3);
        }

        /* --- éš•çŸ³èˆ‡ç‰¹æ•ˆ --- */
        .meteor {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, #feb2b2, #9b2c2c);
            border: 2px solid #fff;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.8);
            z-index: 10;
            white-space: nowrap;
        }
        .meteor-text {
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            text-shadow: 0 0 5px black;
        }
        
        .laser {
            position: absolute;
            width: 8px;
            background-color: #0bc5ea;
            transform-origin: bottom center;
            z-index: 5;
            opacity: 0.9;
            border-radius: 4px;
            box-shadow: 0 0 15px #0bc5ea, 0 0 30px #0bc5ea;
            transition: opacity 0.2s;
        }

        /* RWD */
        @media (min-width: 768px) {
            .hanzi { font-size: 4rem; }
            .zhuyin-box { height: 4rem; }
            .bpmf-symbol { font-size: 1.1rem; }
            .meteor { width: 110px; height: 110px; font-size: 1.6rem; }
        }

        #game-area {
            position: relative;
            width: 100%;
            height: calc(100vh - 180px);
            overflow: hidden;
        }

        #turret-area {
            height: 180px;
            background: linear-gradient(to top, #1a202c, #2d3748);
            border-top: 4px solid #4fd1c5;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            z-index: 20;
            position: relative;
            box-shadow: 0 -5px 20px rgba(79, 209, 197, 0.3);
        }

        .turret-btn { position: relative; transition: transform 0.1s; }
        .turret-base {
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            width: 70%; height: 25px; 
            background: linear-gradient(to right, #4a5568, #718096, #4a5568);
            border-radius: 4px; z-index: -1;
            border: 1px solid #a0aec0;
        }
        
        .flash-red { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim {
            0% { background-color: rgba(255, 0, 0, 0.5); }
            100% { background-color: transparent; }
        }

        /* ç²’å­ç³»çµ± */
        .confetti, .fire-particle {
            position: absolute;
            width: 10px; height: 10px;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .confetti { animation: confetti-explode 1s ease-out forwards; }
        @keyframes confetti-explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .fire-particle {
            box-shadow: 0 0 10px currentColor;
            animation: fire-explode 0.6s ease-out forwards;
        }
        @keyframes fire-explode {
            0% { transform: translate(0, 0) scale(1.5); opacity: 1; }
            50% { opacity: 0.8; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-table { width: 100%; text-align: left; border-collapse: collapse; }
        .rank-table th, .rank-table td { padding: 12px 8px; border-bottom: 1px solid #e2e8f0; }
        .rank-table th { background-color: #ebf8ff; color: #2c5282; font-weight: bold; }
        .rank-1 { color: #d69e2e; font-weight: bold; }
        .rank-2 { color: #718096; font-weight: bold; }
        .rank-3 { color: #b7791f; font-weight: bold; }

        /* é—œå¡é¸æ“‡æŒ‰éˆ•æ¨£å¼ - æ˜Ÿçƒç‰ˆ */
        .level-select-btn {
            background: radial-gradient(circle at 30% 30%, #63b3ed, #2b6cb0, #1a365d);
            color: white;
            border: 2px solid #90cdf4;
            box-shadow: 
                0 0 15px rgba(66, 153, 225, 0.4), 
                inset -5px -5px 10px rgba(0,0,0,0.5); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Noto Serif TC", serif;
            
            border-radius: 50%;
            width: 90px;
            height: 90px;
            flex: 0 0 auto;
            
            text-align: center;
            line-height: 1.2;
            padding: 0.2rem;
            position: relative;
            overflow: hidden;
            font-size: 1.1rem;
            
            z-index: 1;
            cursor: pointer;
            pointer-events: auto;
        }

        .level-select-btn::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 10%;
            width: 20%;
            height: 10%;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            filter: blur(2px);
            transform: rotate(-45deg);
            pointer-events: none;
        }

        .level-select-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 
                0 0 20px rgba(99, 179, 237, 0.8),
                inset -5px -5px 10px rgba(0,0,0,0.5);
            border-color: #fff;
            z-index: 10;
        }

        .level-select-btn.selected {
            background: radial-gradient(circle at 30% 30%, #faf089, #d69e2e, #744210);
            border-color: #ffff00;
            box-shadow: 
                0 0 25px rgba(236, 201, 75, 0.8),
                inset -5px -5px 10px rgba(0,0,0,0.3);
            transform: scale(1.15);
            color: #4a2500;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            z-index: 2;
        }
        
        .neon-text {
            text-shadow: 0 0 5px rgba(255,255,255,0.8), 0 0 10px rgba(255,255,255,0.5);
        }

        /* HUD èˆ‡ é¢æ¿æ¨£å¼ */
        .hud-panel {
            background: rgba(16, 24, 40, 0.85); /* åŠé€æ˜æ·±è—è‰² */
            border: 1px solid rgba(66, 153, 225, 0.5);
            box-shadow: 0 0 20px rgba(66, 153, 225, 0.2), inset 0 0 20px rgba(66, 153, 225, 0.1);
            backdrop-filter: blur(5px);
        }

        /* å³ä¸Šè§’ Home æŒ‰éˆ• */
        .sci-fi-home-btn {
            background: rgba(13, 20, 30, 0.9);
            border: 2px solid #4fd1c5;
            color: #4fd1c5;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(79, 209, 197, 0.3), inset 0 0 5px rgba(79, 209, 197, 0.2);
            position: relative;
            z-index: 50;
            pointer-events: auto;
        }

        .sci-fi-home-btn:hover {
            background: rgba(79, 209, 197, 0.2);
            box-shadow: 0 0 20px rgba(79, 209, 197, 0.6), inset 0 0 10px rgba(79, 209, 197, 0.4);
            transform: scale(1.1) rotate(0deg);
            border-color: #81e6d9;
        }

        .sci-fi-home-btn:active {
            transform: scale(0.95);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(79, 209, 197, 0.3); border-color: #4fd1c5; }
            50% { box-shadow: 0 0 15px rgba(79, 209, 197, 0.6); border-color: #81e6d9; }
        }
        .sci-fi-home-btn {
            animation: pulse-glow 3s infinite;
        }

        /* --- æ–°å¢ï¼šæ’è¡Œæ¦œå…§éƒ¨æ¨™ç±¤èˆ‡æ²è»¸æ¨£å¼ --- */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2b6cb0; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }

        .lb-tab-btn {
            background: rgba(16, 24, 40, 0.6);
            border: 1px solid #4a5568;
            color: #a0aec0;
            padding: 8px 16px;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-weight: bold;
            font-family: "Noto Serif TC", serif;
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
        }
        .lb-tab-btn:hover {
            border-color: #63b3ed;
            color: #63b3ed;
        }
        .lb-tab-btn.active {
            background: linear-gradient(135deg, #2b6cb0, #2c5282);
            color: white;
            border-color: #63b3ed;
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.5);
        }

    </style>
</head>
<body class="text-white">

    <!-- èƒŒæ™¯æ˜Ÿç©º -->
    <div class="starfield">
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
    </div>

    <!-- éŠæˆ² HUD (é è¨­éš±è—ï¼ŒéŠæˆ²é–‹å§‹æ™‚é¡¯ç¤º) -->
    <div id="game-hud" class="fixed top-0 left-0 w-full p-2 md:p-4 flex justify-between items-start z-50 pointer-events-none hidden">
        <div class="bg-gray-900 bg-opacity-70 px-4 py-2 rounded-lg border border-yellow-500 shadow-[0_0_10px_rgba(236,201,75,0.5)]">
            <div class="text-xs text-yellow-300 font-mono tracking-widest">SCORE</div>
            <div class="text-3xl font-bold text-yellow-400 font-mono neon-text" id="score-display">0</div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 top-2 bg-gray-900 bg-opacity-70 px-6 py-2 rounded-full border border-red-500 shadow-[0_0_15px_rgba(245,101,101,0.5)]">
            <span id="lives-display" class="text-3xl drop-shadow-md">â¤ï¸â¤ï¸â¤ï¸</span>
        </div>
        
        <div class="flex">
            <button id="home-btn" class="sci-fi-home-btn hidden" title="ç³»çµ±æš«åœ/å›é¦–é ">
                ğŸ 
            </button>
        </div>
    </div>

    <div id="flash-layer" class="fixed inset-0 pointer-events-none z-40"></div>

    <div id="game-container" class="w-full h-screen flex flex-col">
        <div id="game-area"></div>
        <div id="turret-area"></div>
    </div>

    <!-- æš«åœé¸å–® -->
    <div id="pause-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[70] backdrop-blur-sm hidden">
        <div class="hud-panel p-8 rounded-xl text-center max-w-sm w-full mx-4 border-2 border-blue-400">
            <h2 class="text-3xl font-bold mb-2 text-blue-300 font-[Orbitron] tracking-wider neon-text">SYSTEM PAUSED</h2>
            <p class="text-gray-400 mb-6 text-sm">ç³»çµ±å·²æš«åœï¼Œç­‰å¾…æŒ‡ä»¤...</p>
            <button id="resume-game-btn" class="block w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-bold py-3 px-6 rounded-lg mb-4 shadow-lg transition transform active:scale-95 border border-green-500 tracking-wider">
                â–¶ ç¹¼çºŒä»»å‹™
            </button>
            <button id="quit-game-btn" class="block w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform active:scale-95 border border-red-500 tracking-wider">
                ğŸ  æ”¾æ£„è¿”å›é¦–é 
            </button>
        </div>
    </div>

    <!-- æ•™å­¸å›é¥‹ -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] backdrop-blur-sm hidden">
        <div class="bg-red-900 bg-opacity-90 text-white p-6 rounded-2xl border-4 border-red-500 max-w-sm w-full text-center shadow-[0_0_30px_rgba(245,101,101,0.8)] relative">
            <div class="text-4xl mb-2">âš ï¸ è­¦å‘Š âš ï¸</div>
            <h3 class="text-xl font-bold mb-4" id="fb-title">éš•çŸ³é˜²ç¦¦å¤±æ•—ï¼</h3>
            <div class="bg-black bg-opacity-50 p-4 rounded-lg mb-6 text-left border border-red-300">
                <p class="text-yellow-300 font-bold text-lg mb-2">é¡Œç›®ï¼š<span id="fb-question" class="text-white"></span></p>
                <p class="text-green-300 font-bold text-lg mb-2">æ­£ç¢ºç­”æ¡ˆï¼š<span id="fb-answer" class="text-3xl font-serif bg-white text-black px-2 rounded"></span></p>
                <hr class="border-gray-600 my-2">
                <p class="text-gray-200 text-sm leading-relaxed" id="fb-explanation"></p>
            </div>
            <button id="resume-feedback-btn" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-400 hover:to-green-600 text-white font-bold text-xl py-3 rounded-xl shadow-lg transform transition active:scale-95 border border-green-400">
                äº†è§£ï¼Œç¹¼çºŒæˆ°é¬¥ï¼
            </button>
        </div>
    </div>

    <!-- ä¸»é¸å–®/çµç®—/æ’è¡Œæ¦œ å½ˆçª— -->
    <div id="modal-overlay" class="fixed inset-0 flex items-center justify-center z-[60] overflow-y-auto" style="background: rgba(0,0,0,0.6);">
        <div class="hud-panel text-white p-6 md:p-8 rounded-2xl max-w-2xl w-full text-center my-8 relative overflow-hidden flex flex-col justify-center min-h-[500px]">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent shadow-[0_0_10px_#22d3ee]"></div>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent shadow-[0_0_10px_#22d3ee]"></div>

            <h1 class="text-5xl md:text-6xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 to-blue-600 font-[Orbitron] tracking-widest neon-text filter drop-shadow-lg">
                STAR BATTLE
            </h1>
            <h2 class="text-2xl font-bold mb-6 text-cyan-100 tracking-widest">åŒéŸ³å­—å¤§ä½œæˆ°</h2>
            
            <p id="status-msg" class="text-sm text-cyan-300 mb-4 h-6 font-mono animate-pulse"></p>

            <div id="start-screen-content" class="w-full">
                <div class="mb-8">
                    <p class="text-cyan-200 text-sm mb-4 tracking-widest uppercase border-b border-cyan-800 pb-2 inline-block">
                        // SELECT TARGET SECTOR //
                    </p>
                    
                    <!-- ä½¿ç”¨ Flexbox é€²è¡Œ 5+2 æ’åˆ— -->
                    <div class="flex flex-wrap justify-center gap-4 max-w-4xl mx-auto" id="level-btn-container">
                        <button class="level-select-btn font-bold text-lg selected" data-value="yi">
                            æ„<br>ç¾©<br>æ˜“
                        </button>
                        <button class="level-select-btn font-bold text-xl" data-value="zai">
                            åœ¨<br>å†
                        </button>
                        <button class="level-select-btn font-bold text-lg" data-value="shi">
                            äº‹<br>ä¸–<br>å¸‚
                        </button>
                        <button class="level-select-btn font-bold text-lg" data-value="xiang">
                            æƒ³<br>éŸ¿<br>äº«
                        </button>
                        <button class="level-select-btn font-bold text-xl" data-value="bo">
                            æ’¥<br>æ³¢
                        </button>
                         <button class="level-select-btn font-bold text-xl" data-value="shen">
                            ä¼¸<br>èº«
                        </button>
                        <button class="level-select-btn font-bold text-xl" data-value="yin_ying">
                            å› <br>æ‡‰
                        </button>
                    </div>
                </div>

                <div class="flex flex-col gap-4 max-w-xs mx-auto mt-8">
                    <button id="start-btn" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-white font-bold text-2xl py-4 rounded-lg shadow-[0_0_20px_rgba(236,201,75,0.5)] transform transition hover:scale-105 active:scale-95 border-2 border-yellow-300 tracking-widest">
                        ğŸš€ å‡ºæ“Š
                    </button>
                    <button id="view-rank-btn" class="w-full bg-transparent hover:bg-cyan-900/30 text-cyan-300 font-bold text-lg py-2 rounded-lg border border-cyan-700 hover:border-cyan-400 transition-all flex items-center justify-center gap-2">
                        <span>ğŸ†</span> æŸ¥çœ‹è‹±é›„æ¦œ
                    </button>
                </div>
            </div>

            <div id="game-over-content" class="hidden w-full">
                <p class="text-4xl font-bold text-red-500 mb-6 font-[Orbitron] tracking-widest neon-text">MISSION REPORT</p>
                <div class="bg-gray-900 bg-opacity-60 p-8 rounded-xl mb-8 border border-gray-700 relative inline-block min-w-[200px]">
                    <p class="text-sm text-gray-400 mb-2 tracking-widest">FINAL SCORE</p>
                    <p class="text-7xl font-bold text-yellow-400 font-mono neon-text leading-none" id="final-score">0</p>
                </div>

                <div id="save-score-section" class="mb-8 text-left bg-cyan-900 bg-opacity-20 p-6 rounded-xl border border-cyan-800 relative max-w-md mx-auto">
                    <label class="block font-bold mb-3 text-cyan-300 text-sm tracking-wide">
                        // PILOT ID REGISTRATION //
                    </label>
                    <div class="flex gap-3">
                        <input type="text" id="nickname-input" placeholder="è¼¸å…¥ä»£è™Ÿ..." class="flex-1 p-3 bg-black bg-opacity-50 border border-cyan-700 rounded text-white text-lg focus:outline-none focus:border-cyan-400 placeholder-gray-600 text-center font-mono">
                        <button id="save-score-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold px-6 py-2 rounded shadow transition border border-green-400 whitespace-nowrap">
                            ç¢ºèª
                        </button>
                    </div>
                </div>

                <button id="back-to-menu-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 px-8 rounded-lg shadow-lg border border-gray-600 transition hover:text-white">
                    è¿”å›ç¸½éƒ¨
                </button>
            </div>

            <div id="leaderboard-content" class="hidden w-full text-gray-800">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h2 class="text-2xl font-bold text-cyan-400 flex items-center gap-2">
                        <span class="text-3xl">ğŸ†</span> æ˜Ÿéš›è‹±é›„æ¦œ
                    </h2>
                </div>
                
                <!-- æ–°å¢ï¼šé—œå¡åˆ‡æ›æ¨™ç±¤åˆ— -->
                <div id="lb-tabs-container" class="flex overflow-x-auto gap-2 mb-4 pb-2 px-1 custom-scrollbar w-full">
                    <!-- JS æœƒè‡ªå‹•ç”¢ç”Ÿæ¨™ç±¤ -->
                </div>
                
                <div class="overflow-y-auto max-h-[300px] border border-cyan-800 rounded-lg mb-6 bg-gray-900 bg-opacity-80 custom-scrollbar">
                    <table class="rank-table w-full text-left">
                        <thead class="sticky top-0 bg-cyan-900 text-cyan-200">
                            <tr>
                                <th class="w-16 text-center py-3 bg-cyan-950">#</th>
                                <th class="py-3 bg-cyan-950">ä»£è™Ÿ</th>
                                <th class="text-right pr-6 py-3 bg-cyan-950">ç©åˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="rank-list-body" class="text-cyan-100">
                            <tr><td colspan="3" class="text-center py-8 text-gray-500">æ­£åœ¨æ¥æ”¶æ˜Ÿéš›æ•¸æ“š...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <button id="close-rank-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-3 rounded-lg transition border border-gray-600">
                    é—œé–‰é€šè¨Š
                </button>
            </div>
        </div>
    </div>

    <!-- æ¨¡çµ„åŒ–è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAZreTKruIWq9fGt40Iktq1amqiFNS0P2k",
            authDomain: "worduniverse.firebaseapp.com",
            projectId: "worduniverse",
            storageBucket: "worduniverse.firebasestorage.app",
            messagingSenderId: "621098829006",
            appId: "1:621098829006:web:794dddff45087a5cee3c9f",
            measurementId: "G-WGVQV8L8DH"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // åˆå§‹åŒ– Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }
        
        let currentUser = null;

        const initAuth = async () => {
            if (!auth) return;
            
            const statusMsg = document.getElementById('status-msg');
            if(statusMsg) statusMsg.innerText = "æ­£åœ¨å»ºç«‹åŠ å¯†é€£ç·š...";
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error", e);
                if(statusMsg) statusMsg.innerText = "é›¢ç·šè¨“ç·´æ¨¡å¼ (ç„¡æ³•å­˜æª”)";
            }
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                const statusMsg = document.getElementById('status-msg');
                if (user && statusMsg) statusMsg.innerText = "";
            });
        }
        
        initAuth();

        // --- Firestore é‚è¼¯ ---
        async function saveScoreToCloud(level, name, score) {
            if (!currentUser || score === 0 || !db) return;
            try {
                const currentAppId = appId === 'default-app-id' ? 'word-battle-v1' : appId;
                
                const colRef = collection(db, 'artifacts', currentAppId, 'public', 'data', `leaderboard_${level}`);
                await addDoc(colRef, {
                    name: name,
                    score: score,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                return true;
            } catch (e) {
                console.error("Error saving score:", e);
                alert("å‚³è¼¸å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨Šè™Ÿ");
                return false;
            }
        }

        async function fetchLeaderboard(level) {
            if (!currentUser || !db) return [];
            try {
                const currentAppId = appId === 'default-app-id' ? 'word-battle-v1' : appId;
                
                const colRef = collection(db, 'artifacts', currentAppId, 'public', 'data', `leaderboard_${level}`);
                const snapshot = await getDocs(colRef);
                let scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.score !== undefined && data.name) scores.push(data);
                });
                scores.sort((a, b) => b.score - a.score);
                return scores.slice(0, 10);
            } catch (e) {
                console.error("Error fetching leaderboard:", e);
                return [];
            }
        }

        // --- éŠæˆ²è³‡æ–™èˆ‡éŸ³æ•ˆ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(80, now + 0.3);
                gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'laser') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            }
        }

        // --- æ“´å……é¡Œåº«è³‡æ–™ (å«æ•™å­¸å›é¥‹) ---
        const gameData = {
            "yi": { 
                turrets: [{char:"æ„",zhuyin:"ã„§Ë‹"},{char:"ç¾©",zhuyin:"ã„§Ë‹"},{char:"æ˜“",zhuyin:"ã„§Ë‹"}], 
                questions: [
                    {q:"__æ€",ans:"æ„", explain:"æ„æ€ï¼šæƒ³æ³•ã€å¿µé ­ã€‚ä¾‹ï¼šä¸å¥½æ„æ€ã€æœ‰é»æ„æ€ã€‚"},
                    {q:"åŒ__",ans:"æ„", explain:"åŒæ„ï¼šè´Šæˆã€å¿—è¶£ç›¸åŒã€‚"},
                    {q:"__è¦‹",ans:"æ„", explain:"æ„è¦‹ï¼šå°äº‹æƒ…çš„çœ‹æ³•ã€‚"},
                    {q:"æ­£__",ans:"ç¾©", explain:"æ­£ç¾©ï¼šåˆä¹çœŸç†ã€å…¬ç›Šçš„ã€‚"},
                    {q:"__å·¥",ans:"ç¾©", explain:"ç¾©å·¥ï¼šå¿—é¡˜æœå‹™çš„äººã€‚"},
                    {q:"æ„__",ans:"ç¾©", explain:"æ„ç¾©ï¼šåƒ¹å€¼ã€ä½œç”¨ã€‚"},
                    {q:"å®¹__",ans:"æ˜“", explain:"å®¹æ˜“ï¼šç°¡å–®ã€ä¸å›°é›£ã€‚"},
                    {q:"äº¤__",ans:"æ˜“", explain:"äº¤æ˜“ï¼šè²·è³£ã€äº¤æ›ã€‚"},
                    {q:"å¹³__",ans:"æ˜“", explain:"å¹³æ˜“ï¼šæ…‹åº¦å’Œè—¹ã€å…§å®¹æ·ºé¡¯ã€‚"}
                ] 
            },
            "zai": { 
                turrets: [{char:"åœ¨",zhuyin:"ã„—ã„Ë‹"},{char:"å†",zhuyin:"ã„—ã„Ë‹"}], 
                questions: [
                    {q:"ç¾__",ans:"åœ¨", explain:"ç¾åœ¨ï¼šè¡¨ç¤ºæ™‚é–“ã€‚"},
                    {q:"__å®¶",ans:"åœ¨", explain:"åœ¨å®¶ï¼šè™•æ–¼å®¶ä¸­ã€‚"},
                    {q:"å¯¦__",ans:"åœ¨", explain:"å¯¦åœ¨ï¼šçœŸå¯¦ã€ä¸è™›å‡ã€‚"},
                    {q:"__è¦‹",ans:"å†", explain:"å†è¦‹ï¼šä¸‹ä¸€æ¬¡è¦‹é¢ï¼Œè¡¨ç¤ºé“åˆ¥ã€‚"},
                    {q:"__æ¬¡",ans:"å†", explain:"å†æ¬¡ï¼šç¬¬äºŒæ¬¡ã€åˆä¸€æ¬¡ã€‚"},
                    {q:"ä¸€__",ans:"å†", explain:"ä¸€å†ï¼šä¸€æ¬¡åˆä¸€æ¬¡ã€é‡è¤‡ã€‚"}
                ] 
            },
            "shi": { 
                turrets: [{char:"äº‹",zhuyin:"ã„•Ë‹"},{char:"ä¸–",zhuyin:"ã„•Ë‹"},{char:"å¸‚",zhuyin:"ã„•Ë‹"}], 
                questions: [
                    {q:"æ•…__",ans:"äº‹", explain:"æ•…äº‹ï¼šå‚³èªªèˆŠäº‹ã€æƒ…ç¯€ã€‚"},
                    {q:"åš__",ans:"äº‹", explain:"åšäº‹ï¼šå·¥ä½œã€è™•ç†äº‹å‹™ã€‚"},
                    {q:"__ç•Œ",ans:"ä¸–", explain:"ä¸–ç•Œï¼šåœ°çƒä¸Šæ‰€æœ‰åœ°æ–¹ã€‚"},
                    {q:"__ç´€",ans:"ä¸–", explain:"ä¸–ç´€ï¼šä¸€ç™¾å¹´çš„æ™‚é–“å–®ä½ã€‚"},
                    {q:"åŸ__",ans:"å¸‚", explain:"åŸå¸‚ï¼šäººå£å¯†é›†ã€å·¥å•†æ¥­ç™¼é”çš„åœ°å€ã€‚"},
                    {q:"å¤œ__",ans:"å¸‚", explain:"å¤œå¸‚ï¼šå¤œé–“åšè²·è³£çš„å¸‚é›†ã€‚"}
                ] 
            },
            "xiang": { 
                turrets: [{char:"æƒ³",zhuyin:"ã„’ã„§ã„¤Ë‡"},{char:"éŸ¿",zhuyin:"ã„’ã„§ã„¤Ë‡"},{char:"äº«",zhuyin:"ã„’ã„§ã„¤Ë‡"}], 
                questions: [
                    {q:"__åƒ",ans:"æƒ³", explain:"æƒ³åƒï¼šåœ¨è…¦æµ·ä¸­æ§‹æ€å½¢è±¡ã€‚"},
                    {q:"__å¿µ",ans:"æƒ³", explain:"æƒ³å¿µï¼šæ€å¿µã€æ‡·å¿µã€‚"},
                    {q:"è²__",ans:"éŸ¿", explain:"è²éŸ¿ï¼šè²éŸ³ã€‚"},
                    {q:"__äº®",ans:"éŸ¿", explain:"éŸ¿äº®ï¼šè²éŸ³å®å¤§ã€‚"},
                    {q:"__å—",ans:"äº«", explain:"äº«å—ï¼šç²¾ç¥æˆ–ç‰©è³ªä¸Šçš„å—ç”¨ã€‚"},
                    {q:"åˆ†__",ans:"äº«", explain:"åˆ†äº«ï¼šå…±åŒä½¿ç”¨æˆ–æ“æœ‰ã€‚"}
                ] 
            },
             "bo": { 
                turrets: [{char:"æ’¥",zhuyin:"ã„…ã„›"},{char:"æ³¢",zhuyin:"ã„…ã„›"}], 
                questions: [
                    {q:"__æ‰“",ans:"æ’¥", explain:"æ’¥æ‰“ï¼šæ©«å‘æ¨å‹•ï¼Œå¼•ç”³ç‚ºæ‰“é›»è©±ã€‚"},
                    {q:"__å¼„",ans:"æ’¥", explain:"æ’¥å¼„ï¼šä¾†å›æ¨å‹•ã€‚"},
                    {q:"__æ¬¾",ans:"æ’¥", explain:"æ’¥æ¬¾ï¼šèª¿ç™¼æ¬¾é …ã€‚"},
                    {q:"__æµª",ans:"æ³¢", explain:"æ³¢æµªï¼šæ°´é¢å› éœ‡å‹•è€Œå½¢æˆçš„èµ·ä¼ã€‚"},
                    {q:"æ°´__",ans:"æ³¢", explain:"æ°´æ³¢ï¼šæ°´çš„æ³¢ç´‹ã€‚"},
                    {q:"è²__",ans:"æ³¢", explain:"è²æ³¢ï¼šè²éŸ³å‚³æ’­æ™‚æ‰€ç”¢ç”Ÿçš„æ³¢å‹•ã€‚"},
                    {q:"__å‹•",ans:"æ³¢", explain:"æ³¢å‹•ï¼šåƒæ³¢æµªä¸€æ¨£èµ·ä¼ä¸å®šã€‚"}
                ] 
            },
             "shen": { 
                turrets: [{char:"ä¼¸",zhuyin:"ã„•ã„£"},{char:"èº«",zhuyin:"ã„•ã„£"}], 
                questions: [
                    {q:"__å‡ºé›™æ‰‹",ans:"ä¼¸", explain:"ä¼¸æ‰‹ï¼šå±•é–‹æ‰‹è‡‚ã€‚ä¾‹å¦‚ï¼šä¼¸å‡ºé›™æ‰‹ã€‚"}, 
                    {q:"__ç¸®",ans:"ä¼¸", explain:"ä¼¸ç¸®ï¼šå¼•é•·èˆ‡ç¸®çŸ­ã€‚"},
                    {q:"__å¼µ",ans:"ä¼¸", explain:"ä¼¸å¼µï¼šæ“´å¤§ã€é—¡æ˜ (å¦‚ï¼šä¼¸å¼µæ­£ç¾©)ã€‚"},
                    {q:"__é«”",ans:"èº«", explain:"èº«é«”ï¼šè»€é«”ã€‚"},
                    {q:"__é«˜",ans:"èº«", explain:"èº«é«˜ï¼šèº«é«”çš„é«˜åº¦ã€‚"},
                    {q:"__åˆ†",ans:"èº«", explain:"èº«åˆ†ï¼šå€‹äººçš„åœ°ä½æˆ–è³‡æ ¼ã€‚"},
                    {q:"__æ‰‹çŸ¯å¥",ans:"èº«", explain:"èº«æ‰‹ï¼šæŒ‡æœ¬é ˜ã€æ­¦è—ã€‚ä¾‹å¦‚ï¼šèº«æ‰‹çŸ¯å¥ã€‚"} 
                ] 
            },
            "yin_ying": {
                turrets: [{char:"å› ",zhuyin:"ã„§ã„£"},{char:"æ‡‰",zhuyin:"ã„§ã„¥"}],
                questions: [
                    {q:"__ç‚º",ans:"å› ", explain:"å› ç‚ºï¼šé€£è©ï¼Œè¡¨ç¤ºäº‹æƒ…çš„åŸå› ã€‚"},
                    {q:"åŸ__",ans:"å› ", explain:"åŸå› ï¼šäº‹ç‰©ç™¼ç”Ÿçš„ç·£æ•…ã€‚"},
                    {q:"__ç´ ",ans:"å› ", explain:"å› ç´ ï¼šæ§‹æˆäº‹ç‰©çš„è¦ç´ ã€‚"},
                    {q:"__è©²",ans:"æ‡‰", explain:"æ‡‰è©²ï¼šç†æ‰€ç•¶ç„¶ï¼Œåˆ†å…§æ‰€ç•¶ç‚ºã€‚"},
                    {q:"ä¾›__",ans:"æ‡‰", explain:"ä¾›æ‡‰ï¼šä¾›çµ¦éœ€è¦çš„ç‰©è³‡ã€‚"},
                    {q:"å__",ans:"æ‡‰", explain:"åæ‡‰ï¼šå—åˆºæ¿€è€Œå¼•èµ·çš„å‹•ä½œæˆ–æ„Ÿè¦ºã€‚"},
                    {q:"é©__",ans:"æ‡‰", explain:"é©æ‡‰ï¼šç”Ÿå­˜æˆ–ç›¸è™•çš„ç‹€æ…‹å”èª¿ã€‚"}
                ]
            }
        };

        function parseZhuyin(str) {
            const tones = ['Ë™', 'ËŠ', 'Ë‡', 'Ë‹'];
            let tone = "", isNeutral = false, symbols = [];
            if (str.includes('Ë™')) { isNeutral = true; str = str.replace('Ë™', ''); }
            for (let t of tones) { if (t !== 'Ë™' && str.includes(t)) { tone = t; str = str.replace(t, ''); break; } }
            symbols = str.split('');
            return { symbols, tone, isNeutral };
        }

        function generateZhuyinHTML(zhuyinStr) {
            const { symbols, tone, isNeutral } = parseZhuyin(zhuyinStr);
            let html = '<div class="zhuyin-box">';
            if (isNeutral) html += `<div class="tone-neutral">Ë™</div>`;
            symbols.forEach((sym, index) => {
                const isLast = index === symbols.length - 1;
                html += `<div class="bpmf-symbol">${sym}${(isLast && tone) ? `<span class="tone-mark">${tone}</span>` : ''}</div>`;
            });
            html += '</div>';
            return html;
        }

        // --- éŠæˆ²ç‹€æ…‹ ---
        let state = {
            score: 0, lives: 3, isPlaying: false, level: 'yi',
            meteors: [], 
            spawnRate: 2400,
            fallSpeed: 2, lastSpawnTime: 0, animationFrameId: null,
            isPaused: false
        };

        // DOM Elements
        const gameArea = document.getElementById('game-area');
        const turretArea = document.getElementById('turret-area');
        const scoreDisplay = document.getElementById('score-display');
        const livesDisplay = document.getElementById('lives-display');
        const gameHud = document.getElementById('game-hud');
        
        const modal = document.getElementById('modal-overlay');
        const startScreen = document.getElementById('start-screen-content');
        const gameOverScreen = document.getElementById('game-over-content');
        const leaderboardScreen = document.getElementById('leaderboard-content');
        const saveScoreSection = document.getElementById('save-score-section');
        
        const feedbackModal = document.getElementById('feedback-modal');
        const fbTitle = document.getElementById('fb-title');
        const fbQuestion = document.getElementById('fb-question');
        const fbAnswer = document.getElementById('fb-answer');
        const fbExplanation = document.getElementById('fb-explanation');
        const resumeFeedbackBtn = document.getElementById('resume-feedback-btn');

        const pauseModal = document.getElementById('pause-modal');
        const resumeGameBtn = document.getElementById('resume-game-btn');
        const quitGameBtn = document.getElementById('quit-game-btn');
        const homeBtn = document.getElementById('home-btn');

        const startBtn = document.getElementById('start-btn');
        const viewRankBtn = document.getElementById('view-rank-btn');
        const closeRankBtn = document.getElementById('close-rank-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const saveScoreBtn = document.getElementById('save-score-btn');
        
        const nicknameInput = document.getElementById('nickname-input');
        const finalScoreEl = document.getElementById('final-score');
        const flashLayer = document.getElementById('flash-layer');
        const rankListBody = document.getElementById('rank-list-body');
        
        // é—œå¡é¸æ“‡æŒ‰éˆ•é‚è¼¯
        const levelBtnContainer = document.getElementById('level-btn-container');
        if(levelBtnContainer){
            levelBtnContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.level-select-btn');
                if (!btn) return;
                const allBtns = levelBtnContainer.querySelectorAll('.level-select-btn');
                allBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.level = btn.dataset.value;
            });
        }

        function initTurrets(levelKey) {
            if(!turretArea) return;
            turretArea.innerHTML = '';
            gameData[levelKey].turrets.forEach(t => {
                const btn = document.createElement('div');
                btn.className = 'turret-btn cursor-pointer';
                btn.innerHTML = `
                    <div class="char-card pointer-events-none">
                        <div class="hanzi">${t.char}</div>
                        ${generateZhuyinHTML(t.zhuyin)}
                    </div>
                    <div class="turret-base"></div>
                `;
                const handleFire = (e) => { e.preventDefault(); fireTurret(btn, t.char); };
                btn.addEventListener('click', () => fireTurret(btn, t.char));
                btn.addEventListener('touchstart', handleFire);
                turretArea.appendChild(btn);
            });
        }

        function fireTurret(turretEl, char) {
            if (!state.isPlaying || state.isPaused) return; 
            const card = turretEl.querySelector('.char-card');
            card.style.transform = "scale(0.9)";
            setTimeout(() => card.style.transform = "scale(1)", 100);

            let target = null;
            let maxTop = -999;
            state.meteors.forEach(m => {
                const rect = m.el.getBoundingClientRect();
                if (rect.top > maxTop) { maxTop = rect.top; target = m; }
            });

            if (!target) return;
            createLaser(turretEl, target.el);
            playSound('laser');

            if (target.data.ans === char) {
                state.score += 10;
                playSound('correct');
                updateUI();
                destroyMeteor(target, true);
            } else {
                handleWrongAnswer(target, "å°„æ“ŠéŒ¯èª¤ï¼");
            }
        }

        function handleWrongAnswer(meteorObj, reason="éš•çŸ³é˜²ç¦¦å¤±æ•—ï¼") {
            state.score = Math.max(0, state.score - 5);
            state.lives--;
            playSound('wrong');
            updateUI();
            shakeScreen();
            flashScreen();
            
            state.isPlaying = false; 
            cancelAnimationFrame(state.animationFrameId);

            if (meteorObj && meteorObj.data) {
                if(fbTitle) fbTitle.innerText = reason;
                if(fbQuestion) fbQuestion.innerText = meteorObj.data.q;
                if(fbAnswer) fbAnswer.innerText = meteorObj.data.ans;
                if(fbExplanation) fbExplanation.innerText = meteorObj.data.explain || "è«‹å¤šåŠ ç·´ç¿’ï¼";
                
                if(meteorObj.el && meteorObj.el.parentNode) {
                    const rect = meteorObj.el.getBoundingClientRect();
                    createFireExplosion(rect.left + rect.width/2, rect.top + rect.height/2);
                    meteorObj.el.remove();
                }
                state.meteors = state.meteors.filter(m => m !== meteorObj);
                
                if(feedbackModal) feedbackModal.classList.remove('hidden');
            } else {
                if (state.lives <= 0) gameOver();
                else state.isPlaying = true;
            }
        }

        function resumeFromFeedback() {
            if(feedbackModal) feedbackModal.classList.add('hidden');
            
            if (state.lives <= 0) {
                gameOver();
            } else {
                state.isPlaying = true;
                state.lastSpawnTime = performance.now(); 
                state.animationFrameId = requestAnimationFrame(loop);
            }
        }

        function togglePause() {
            if (!state.isPlaying && !state.isPaused) return;

            if (state.isPaused) {
                state.isPaused = false;
                state.isPlaying = true;
                if(pauseModal) pauseModal.classList.add('hidden');
                state.lastSpawnTime = performance.now();
                state.animationFrameId = requestAnimationFrame(loop);
            } else {
                state.isPaused = true;
                state.isPlaying = false;
                cancelAnimationFrame(state.animationFrameId);
                if(pauseModal) pauseModal.classList.remove('hidden');
            }
        }

        function returnToHome() {
            state.isPlaying = false;
            state.isPaused = false;
            cancelAnimationFrame(state.animationFrameId);
            
            state.meteors.forEach(m => {
                if(m.el) m.el.remove();
            });
            state.meteors = [];
            
            if(gameArea) gameArea.innerHTML = ''; 
            if(turretArea) turretArea.innerHTML = '';
            document.querySelectorAll('.laser, .confetti, .fire-particle').forEach(el => el.remove());

            if(pauseModal) pauseModal.classList.add('hidden');
            if(feedbackModal) feedbackModal.classList.add('hidden');
            if(gameOverScreen) gameOverScreen.classList.add('hidden');
            if(leaderboardScreen) leaderboardScreen.classList.add('hidden');
            
            if(modal) modal.classList.remove('hidden');
            if(startScreen) startScreen.classList.remove('hidden');
            
            if(gameHud) gameHud.classList.add('hidden');
            if(homeBtn) homeBtn.classList.add('hidden');
            
            const statusMsg = document.getElementById('status-msg');
            if(statusMsg) statusMsg.innerText = "";
        }

        function createLaser(startEl, endEl) {
            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

            const laser = document.createElement('div');
            laser.className = 'laser';
            laser.style.width = length + 'px';
            laser.style.left = startX + 'px';
            laser.style.top = startY + 'px';
            laser.style.transform = `rotate(${angle}deg)`;
            document.body.appendChild(laser);
            setTimeout(() => { laser.style.opacity = '0'; setTimeout(() => laser.remove(), 100); }, 100);
        }

        function spawnMeteor() {
            const questions = gameData[state.level].questions;
            const q = questions[Math.floor(Math.random() * questions.length)];
            const el = document.createElement('div');
            el.className = 'meteor';
            el.innerHTML = `<div class="meteor-content"><span class="meteor-text">${q.q}</span></div>`;
            const maxLeft = gameArea.clientWidth - 100;
            el.style.left = (Math.random() * maxLeft) + 'px';
            el.style.top = '-100px';
            gameArea.appendChild(el);
            state.meteors.push({ el: el, data: q, y: -100, speed: state.fallSpeed + (Math.random() * 0.5) });
        }

        function destroyMeteor(meteorObj, isSuccess) {
            const rect = meteorObj.el.getBoundingClientRect();
            createFireExplosion(rect.left + rect.width/2, rect.top + rect.height/2);

            meteorObj.el.remove();
            state.meteors = state.meteors.filter(m => m !== meteorObj);
            
            if (isSuccess) {
                if(state.score > 0 && state.score % 50 === 0) {
                    state.fallSpeed += 0.5;
                    state.spawnRate = Math.max(1200, state.spawnRate - 100);
                }
            }
        }

        function shakeScreen() {
            document.body.style.transform = "translate(5px, 5px)";
            setTimeout(() => document.body.style.transform = "translate(-5px, -5px)", 50);
            setTimeout(() => document.body.style.transform = "translate(0, 0)", 100);
        }

        function flashScreen() {
            if(flashLayer) {
                flashLayer.classList.add('flash-red');
                setTimeout(() => flashLayer.classList.remove('flash-red'), 300);
            }
        }

        function createExplosion(x, y) {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('confetti');
                const colors = ['#f6e05e', '#68d391', '#63b3ed', '#f687b3'];
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                const angle = Math.random() * Math.PI * 2;
                const velocity = 50 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function createFireExplosion(x, y) {
            const particleCount = 15;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('fire-particle');
                
                const fireColors = ['#ff0000', '#ff6600', '#ffcc00'];
                particle.style.backgroundColor = fireColors[Math.floor(Math.random() * fireColors.length)];
                particle.style.color = particle.style.backgroundColor;
                
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 30 + Math.random() * 60;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }

        function loop(timestamp) {
            if (!state.isPlaying || state.isPaused) return;
            if (timestamp - state.lastSpawnTime > state.spawnRate) {
                spawnMeteor();
                state.lastSpawnTime = timestamp;
            }
            state.meteors.forEach(m => {
                m.y += m.speed;
                m.el.style.top = m.y + 'px';
                if (m.y > gameArea.clientHeight - 80) {
                    handleWrongAnswer(m, "éš•çŸ³é˜²ç¦¦å¤±æ•—ï¼");
                }
            });
            state.animationFrameId = requestAnimationFrame(loop);
        }

        function updateUI() {
            if(scoreDisplay) scoreDisplay.innerText = state.score;
            if(livesDisplay) livesDisplay.innerText = "â¤ï¸".repeat(state.lives);
        }

        function startGame() {
            initAudio();
            state.score = 0;
            state.lives = 3;
            state.isPlaying = true;
            state.isPaused = false;
            state.meteors = [];
            state.spawnRate = 2400; 
            state.fallSpeed = window.innerWidth < 768 ? 1.5 : 2;
            if (!state.level) state.level = 'yi';
            
            if(gameArea) gameArea.innerHTML = '';
            if(modal) modal.classList.add('hidden');
            if(startScreen) startScreen.classList.add('hidden');
            if(gameOverScreen) gameOverScreen.classList.add('hidden');
            if(leaderboardScreen) leaderboardScreen.classList.add('hidden');
            
            if(gameHud) gameHud.classList.remove('hidden');
            if(homeBtn) homeBtn.classList.remove('hidden');
            
            initTurrets(state.level);
            updateUI();
            
            state.lastSpawnTime = performance.now();
            state.animationFrameId = requestAnimationFrame(loop);
        }

        function gameOver() {
            state.isPlaying = false;
            cancelAnimationFrame(state.animationFrameId);
            
            if(finalScoreEl) finalScoreEl.innerText = state.score;
            
            if(modal) modal.classList.remove('hidden');
            if(startScreen) startScreen.classList.add('hidden');
            if(leaderboardScreen) leaderboardScreen.classList.add('hidden');
            if(gameOverScreen) gameOverScreen.classList.remove('hidden');
            
            if(homeBtn) homeBtn.classList.add('hidden');
            if(gameHud) gameHud.classList.add('hidden');
            
            if(nicknameInput) nicknameInput.value = '';
            if(saveScoreBtn) {
                saveScoreBtn.disabled = false;
                saveScoreBtn.innerText = "å„²å­˜";
                saveScoreBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                saveScoreBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            }
            
            if(saveScoreSection) {
                if(state.score === 0) {
                     saveScoreSection.classList.add('hidden');
                } else {
                     saveScoreSection.classList.remove('hidden');
                }
            }
        }

        async function submitScore(e) {
            const name = nicknameInput.value.trim();
            if(!name) {
                alert("æŒ‡æ®å®˜ï¼Œè«‹è¼¸å…¥ä»£è™Ÿï¼");
                return;
            }

            saveScoreBtn.innerText = "å‚³è¼¸ä¸­...";
            saveScoreBtn.disabled = true;

            const success = await saveScoreToCloud(state.level, name, state.score);
            
            if (success) {
                saveScoreBtn.innerText = "ç™»éŒ„æˆåŠŸï¼";
                saveScoreBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                saveScoreBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                const rect = saveScoreBtn.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                createExplosion(centerX, centerY);
                
                setTimeout(() => {
                    showLeaderboard();
                }, 1000);
            } else {
                saveScoreBtn.innerText = "é‡è©¦";
                saveScoreBtn.disabled = false;
            }
        }

        function resetToMenu() {
            returnToHome();
            const statusMsg = document.getElementById('status-msg');
            if(statusMsg) statusMsg.innerText = "";
        }

        async function showLeaderboard() {
            if(startScreen) startScreen.classList.add('hidden');
            if(gameOverScreen) gameOverScreen.classList.add('hidden');
            if(leaderboardScreen) leaderboardScreen.classList.remove('hidden');
            
            renderLeaderboardTabs();

            const currentLevel = state.level || 'yi';
            await refreshLeaderboardList(currentLevel);
        }

        function renderLeaderboardTabs() {
            const container = document.getElementById('lb-tabs-container');
            if (!container) return; 
            container.innerHTML = '';
            
            const labels = {
                'yi': 'æ„ç¾©æ˜“', 'zai': 'åœ¨å†', 'shi': 'äº‹ä¸–å¸‚', 
                'xiang': 'æƒ³éŸ¿äº«', 'bo': 'æ’¥æ³¢', 'shen': 'ä¼¸èº«', 'yin_ying': 'å› æ‡‰'
            };

            Object.keys(gameData).forEach(key => {
                const btn = document.createElement('button');
                const isActive = key === (state.level || 'yi');
                btn.className = `lb-tab-btn ${isActive ? 'active' : ''}`;
                btn.innerText = labels[key] || key;
                
                btn.onclick = async () => {
                    document.querySelectorAll('.lb-tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    state.level = key;
                    const startBtns = document.querySelectorAll('.level-select-btn');
                    startBtns.forEach(b => {
                        if (b.dataset.value === key) b.classList.add('selected');
                        else b.classList.remove('selected');
                    });
                    
                    await refreshLeaderboardList(key);
                };
                container.appendChild(btn);
            });
        }

        async function refreshLeaderboardList(level) {
            const rankListBody = document.getElementById('rank-list-body');
            if (!rankListBody) return;
            
            rankListBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-cyan-400 animate-pulse">æ­£åœ¨æ¥æ”¶æ˜Ÿéš›æ•¸æ“š...</td></tr>`;

            const data = await fetchLeaderboard(level);
            
            rankListBody.innerHTML = '';
            if (data.length === 0) {
                rankListBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500">å°šç„¡æŒ‡æ®å®˜ç´€éŒ„ï¼Œæ¶ä¸‹é¦–å‹å§ï¼</td></tr>`;
            } else {
                data.forEach((item, index) => {
                    let rankClass = "";
                    let medal = "";
                    if (index === 0) { rankClass = "text-yellow-400 font-black text-xl"; medal = "ğŸ¥‡"; }
                    else if (index === 1) { rankClass = "text-gray-300 font-bold text-lg"; medal = "ğŸ¥ˆ"; }
                    else if (index === 2) { rankClass = "text-yellow-700 font-bold text-lg"; medal = "ğŸ¥‰"; }
                    else { rankClass = "text-cyan-200"; medal = `<span class="opacity-50 text-sm ml-1">#${index+1}</span>`; }

                    const row = document.createElement('tr');
                    row.className = "hover:bg-cyan-900/30 transition-colors border-b border-cyan-900/30";
                    row.innerHTML = `
                        <td class="text-center py-3">${medal}</td>
                        <td class="py-3 ${rankClass}">${item.name}</td>
                        <td class="text-right pr-6 py-3 font-mono font-bold text-cyan-300">${item.score}</td>
                    `;
                    rankListBody.appendChild(row);
                });
            }
        }

        if(startBtn) startBtn.addEventListener('click', startGame);
        if(saveScoreBtn) saveScoreBtn.addEventListener('click', submitScore);
        if(viewRankBtn) viewRankBtn.addEventListener('click', showLeaderboard);
        if(closeRankBtn) closeRankBtn.addEventListener('click', resetToMenu);
        if(backToMenuBtn) backToMenuBtn.addEventListener('click', resetToMenu);
        if(resumeFeedbackBtn) resumeFeedbackBtn.addEventListener('click', resumeFromFeedback);
        if(homeBtn) homeBtn.addEventListener('click', togglePause);
        if(resumeGameBtn) resumeGameBtn.addEventListener('click', togglePause);
        if(quitGameBtn) quitGameBtn.addEventListener('click', returnToHome);

    </script>
</body>
</html>
