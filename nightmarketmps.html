<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤œå¸‚å¤§å†’éšªï¼šæ­£çµ±æ³¨éŸ³ä¿®æ­£ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Biz+UDPGothic:wght@700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f0f1a;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .zhuyin-font {
            font-family: 'Noto Serif TC', 'Biz UDPGothic', serif;
            line-height: 1;
        }

        /* Neon Effects */
        .neon-text-pink { text-shadow: 0 0 5px #ec4899, 0 0 10px #ec4899; }
        .neon-text-blue { text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6; }
        .neon-text-green { text-shadow: 0 0 5px #10b981, 0 0 10px #10b981; }
        .neon-text-yellow { text-shadow: 0 0 5px #eab308, 0 0 10px #eab308; }

        /* Background */
        .night-market-bg {
            background: radial-gradient(circle at 50% 0%, #2d1b4e 0%, #0f0f1a 60%);
            position: relative;
        }
        .night-market-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(236, 72, 153, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 20%);
            z-index: 0;
            pointer-events: none;
        }

        /* Animations */
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }
        
        .pulse-ring { animation: pulseRing 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulseRing {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- SOUND ENGINE ---
        const useSound = () => {
            const audioCtxRef = useRef(null);
            const [isMuted, setIsMuted] = useState(false);

            const initAudio = () => {
                if (!audioCtxRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtxRef.current = new AudioContext();
                }
                if (audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }
            };

            const playTone = (freq, type, duration, startTime = 0) => {
                if (isMuted || !audioCtxRef.current) return;
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime + startTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + startTime + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(ctx.currentTime + startTime);
                osc.stop(ctx.currentTime + startTime + duration);
            };

            const speak = (text) => {
                if (isMuted || !window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; 
                utterance.rate = 0.8; 
                utterance.pitch = 1.1; 
                window.speechSynthesis.speak(utterance);
            };

            const playSound = (effect, textToSpeak = null) => {
                initAudio();
                if (effect === 'speak' && textToSpeak) {
                    speak(textToSpeak);
                    return;
                }
                if (isMuted) return;
                switch (effect) {
                    case 'correct': playTone(1046.50, 'sine', 0.1, 0); playTone(1318.51, 'sine', 0.3, 0.1); break;
                    case 'wrong': playTone(150, 'sawtooth', 0.3, 0); break;
                    case 'pop': playTone(400, 'square', 0.05, 0); break;
                    case 'click': playTone(800, 'sine', 0.05, 0); break;
                    case 'win': 
                        playTone(523.25, 'triangle', 0.1, 0); 
                        playTone(659.25, 'triangle', 0.1, 0.1); 
                        playTone(783.99, 'triangle', 0.1, 0.2); 
                        playTone(1046.50, 'triangle', 0.6, 0.3); 
                        break;
                }
            };
            const toggleMute = () => setIsMuted(!isMuted);
            return { playSound, isMuted, toggleMute };
        };

        // --- COMPONENTS ---
        const ZhuyinBlock = ({ charCode, size = "md", color = "white", active = false, isBlank = false, isQuestion = false }) => {
            const sizeClasses = {
                sm: { box: "w-8", font: "text-lg", tone: "text-xs", toneRight: "-right-2" },
                md: { box: "w-12", font: "text-3xl", tone: "text-lg", toneRight: "-right-4" },
                lg: { box: "w-16", font: "text-5xl", tone: "text-2xl", toneRight: "-right-6" },
                xl: { box: "w-24", font: "text-7xl", tone: "text-4xl", toneRight: "-right-8" },
            };
            const s = sizeClasses[size];
            const colorClasses = { white: "text-white", black: "text-black", yellow: "text-yellow-300", red: "text-red-400", green: "text-green-400" };
            const c = colorClasses[color];

            if (charCode === "ï¼¿" || isBlank) return <div className={`${s.box} flex items-center justify-center border-b-4 border-white/30 h-full mx-1`}></div>;
            if (charCode === "?" || isQuestion) return <div className={`${s.box} flex items-center justify-center border-4 border-red-500 rounded-lg bg-red-900/30 text-red-400 animate-pulse h-full mx-1`}><span className={`${s.font} font-black`}>?</span></div>;

            const tones = ['Ë™', 'ËŠ', 'Ë‡', 'Ë‹'];
            let tone = '';
            let body = charCode;
            for (let t of tones) { if (charCode.includes(t)) { tone = t; body = charCode.replace(t, ''); break; } }
            const isLightTone = tone === 'Ë™';
            const isSideTone = ['ËŠ', 'Ë‡', 'Ë‹'].includes(tone);
            const bodyChars = body.split('');

            return (
                <div className={`relative flex flex-col items-center justify-center mx-1 select-none ${c} zhuyin-font`}>
                    <div className={`absolute -top-1/4 w-full text-center ${s.tone} font-bold`}>{isLightTone ? 'Ë™' : ''}</div>
                    <div className="flex flex-col items-center leading-none">
                        {bodyChars.map((char, i) => (
                            <span key={i} className={`${s.font} font-bold my-[-2px] relative`}>
                                {char}
                                {isSideTone && i === bodyChars.length - 1 && (
                                    <span className={`absolute top-0 ${s.toneRight} ${s.tone} font-bold`}>{tone}</span>
                                )}
                            </span>
                        ))}
                    </div>
                </div>
            );
        };

        const GameOverModal = ({ score, onRestart }) => (
            <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center p-4 pop-in">
                <div className="bg-gray-800 border-4 border-yellow-400 p-8 rounded-3xl text-center shadow-[0_0_50px_rgba(234,179,8,0.5)] max-w-lg w-full">
                    <div className="text-6xl mb-4">â°</div>
                    <h2 className="text-5xl font-black text-white mb-2 neon-text-yellow">æ™‚é–“åˆ°ï¼</h2>
                    <p className="text-gray-400 text-xl mb-6">ä¾†çœ‹çœ‹ä½ çš„æˆ°ç¸¾</p>
                    <div className="bg-black/40 rounded-xl p-4 mb-8">
                        <div className="text-sm text-gray-400 mb-1">æœ¬æ¬¡å¾—åˆ†</div>
                        <div className="text-7xl font-black text-yellow-300">{score}</div>
                    </div>
                    <button onClick={onRestart} className="w-full bg-gradient-to-r from-pink-500 to-purple-600 py-4 rounded-xl text-2xl font-bold shadow-lg hover:scale-105 transition-transform">
                        å›é¦–é 
                    </button>
                </div>
            </div>
        );

        // --- DATA ---
        const FOOD_ITEMS = [
            { id: 1, name: "çç å¥¶èŒ¶", zhuyinTitle: "ï¼¿ ã„“ã„¨ ã„‹ã„Ë‡ ã„”ã„šËŠ", char: "ç", zhuyin: ["ã„“", "ã„£", " "], emoji: "ğŸ§‹" },
            { id: 2, name: "çç å¥¶èŒ¶", zhuyinTitle: "ã„“ã„£ ï¼¿ ã„‹ã„Ë‡ ã„”ã„šËŠ", char: "ç ", zhuyin: ["ã„“", "ã„¨", " "], emoji: "ğŸ§‹" },
            { id: 3, name: "é›è…¿", zhuyinTitle: "ï¼¿ ã„Šã„¨ã„ŸË‡", char: "é›", zhuyin: ["ã„", "ã„§", " "], emoji: "ğŸ—" },
            { id: 4, name: "é›è…¿", zhuyinTitle: "ã„ã„§ ï¼¿", char: "è…¿", zhuyin: ["ã„Š", "ã„¨ã„Ÿ", "Ë‡"], emoji: "ğŸ—" },
            { id: 5, name: "è‡­è±†è…", zhuyinTitle: "ï¼¿ ã„‰ã„¡Ë‹ ã„ˆã„¨Ë‡", char: "è‡­", zhuyin: ["ã„”", "ã„¡", "Ë‹"], emoji: "ğŸ²" },
            { id: 6, name: "å¤§è…¸åŒ…å°è…¸", zhuyinTitle: "ã„‰ã„šË‹ ï¼¿ ã„…ã„  ã„’ã„§ã„ Ë‡ ã„”ã„¤ËŠ", char: "è…¸", zhuyin: ["ã„”", "ã„¤", "ËŠ"], emoji: "ğŸŒ­" },
            { id: 7, name: "èšµä»”ç…", zhuyinTitle: "ã„œËŠ ã„—Ë‡ ï¼¿", char: "ç…", zhuyin: ["ã„", "ã„§", "ã„¢", " "], emoji: "ğŸ³" },
            { id: 8, name: "æ»·è‚‰é£¯", zhuyinTitle: "ã„Œã„¨Ë‡ ã„–ã„¡Ë‹ ï¼¿", char: "é£¯", zhuyin: ["ã„ˆ", "ã„¢", "Ë‹"], emoji: "ğŸš" },
            { id: 9, name: "åœ°ç“œçƒ", zhuyinTitle: "ã„‰ã„§Ë‹ ã„ã„¨ã„š ï¼¿", char: "çƒ", zhuyin: ["ã„‘", "ã„§", "ã„¡", "ËŠ"], emoji: "ğŸ " },
            { id: 10, name: "ç« é­šç‡’", zhuyinTitle: "ï¼¿ ã„©ËŠ ã„•ã„ ", char: "ç« ", zhuyin: ["ã„“", "ã„¤", " "], emoji: "ğŸ™" },
            { id: 11, name: "æœ¨ç“œç‰›å¥¶", zhuyinTitle: "ï¼¿ ã„ã„¨ã„š ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡", char: "æœ¨", zhuyin: ["ã„‡", "ã„¨", "Ë‹"], emoji: "ğŸ¥›" },
            { id: 12, name: "é¹½é…¥é›", zhuyinTitle: "ï¼¿ ã„™ã„¨ ã„ã„§", char: "é¹½", zhuyin: ["ã„§", "ã„¢", "ËŠ"], emoji: "ğŸ¥¡" },
            { id: 13, name: "çƒ¤ç‰ç±³", zhuyinTitle: "ï¼¿ ã„©Ë‹ ã„‡ã„§Ë‡", char: "çƒ¤", zhuyin: ["ã„", "ã„ ", "Ë‡"], emoji: "ğŸŒ½" },
            { id: 14, name: "è±†èŠ±", zhuyinTitle: "ã„‰ã„¡Ë‹ ï¼¿", char: "èŠ±", zhuyin: ["ã„", "ã„¨", "ã„š", " "], emoji: "ğŸ®" },
            { id: 15, name: "å£½å¸", zhuyinTitle: "ï¼¿ ã„™", char: "å£½", zhuyin: ["ã„•", "ã„¡", "Ë‹"], emoji: "ğŸ£" },
            { id: 16, name: "æ¼¢å ¡", zhuyinTitle: "ã„ã„¢Ë‹ ï¼¿", char: "å ¡", zhuyin: ["ã„…", "ã„ ", "Ë‡"], emoji: "ğŸ”" },
            { id: 17, name: "è–¯æ¢", zhuyinTitle: "ï¼¿ ã„Šã„§ã„ ËŠ", char: "è–¯", zhuyin: ["ã„•", "ã„¨", "Ë‡"], emoji: "ğŸŸ" },
            { id: 18, name: "ç¾©å¤§åˆ©éºµ", zhuyinTitle: "ã„§Ë‹ ã„‰ã„šË‹ ï¼¿ ã„‡ã„§ã„¢Ë‹", char: "åˆ©", zhuyin: ["ã„Œ", "ã„§", "Ë‹"], emoji: "ğŸ" },
        ];

        const SHOP_ITEMS = [
            { name: "é‹å­", zhuyin: "ã„’ã„§ã„ËŠ ã„—Ë™", emoji: "ğŸ‘Ÿ" },
            { name: "å¸½å­", zhuyin: "ã„‡ã„ Ë‹ ã„—Ë™", emoji: "ğŸ§¢" },
            { name: "æ´‹è£", zhuyin: "ã„§ã„¤ËŠ ã„“ã„¨ã„¤", emoji: "ğŸ‘—" },
            { name: "è¡£æœ", zhuyin: "ã„§ ã„ˆã„¨ËŠ", emoji: "ğŸ‘•" },
            { name: "è¤²å­", zhuyin: "ã„ã„¨Ë‹ ã„—Ë™", emoji: "ğŸ‘–" },
            { name: "è¥ªå­", zhuyin: "ã„¨ã„šË‹ ã„—Ë™", emoji: "ğŸ§¦" },
            { name: "çœ¼é¡", zhuyin: "ã„§ã„¢Ë‡ ã„ã„§ã„¥Ë‹", emoji: "ğŸ‘“" },
            { name: "èƒŒåŒ…", zhuyin: "ã„…ã„Ÿ ã„…ã„ ", emoji: "ğŸ’" },
            { name: "æ‰‹éŒ¶", zhuyin: "ã„•ã„¡Ë‡ ã„…ã„§ã„ Ë‡", emoji: "âŒš" },
            { name: "é›¨å‚˜", zhuyin: "ã„©Ë‡ ã„™ã„¢Ë‡", emoji: "â˜‚ï¸" },
            { name: "æˆ’æŒ‡", zhuyin: "ã„ã„§ã„Ë‹ ã„“Ë‡", emoji: "ğŸ’" },
            { name: "å£ç´…", zhuyin: "ã„ã„¡Ë‡ ã„ã„¨ã„¥ËŠ", emoji: "ğŸ’„" },
            { name: "è¶³çƒ", zhuyin: "ã„—ã„¨ËŠ ã„‘ã„§ã„¡ËŠ", emoji: "âš½" },
            { name: "ç±ƒçƒ", zhuyin: "ã„Œã„¢ËŠ ã„‘ã„§ã„¡ËŠ", emoji: "ğŸ€" },
            { name: "æ£’çƒ", zhuyin: "ã„…ã„¤Ë‹ ã„‘ã„§ã„¡ËŠ", emoji: "âš¾" },
            { name: "æ‰‹æ©Ÿ", zhuyin: "ã„•ã„¡Ë‡ ã„ã„§", emoji: "ğŸ“±" },
        ];

        const CONFUSION_MAP = { 'ËŠ': ['Ë‡'], 'Ë‡': ['ËŠ'], 'ã„¡': ['ã„›'], 'ã„›': ['ã„¡', 'ã„¨ã„›'], 'ã„£': ['ã„¥'], 'ã„¥': ['ã„£', 'ã„¨ã„¥'], 'ã„¢': ['ã„¤'], 'ã„¤': ['ã„¢'], 'ã„—': ['ã„“'], 'ã„“': ['ã„—'], 'ã„˜': ['ã„”'], 'ã„”': ['ã„˜'], 'ã„™': ['ã„•'], 'ã„•': ['ã„™'], 'ã„–': ['ã„Œ'], 'ã„Œ': ['ã„–'], 'ã„§ã„£': ['ã„§ã„¥'], 'ã„§ã„¥': ['ã„§ã„£'], 'ã„‹': ['ã„Œ'], 'ã„Œ': ['ã„‹'] };
        const INITIALS = "ã„…ã„†ã„‡ã„ˆã„‰ã„Šã„‹ã„Œã„ã„ã„ã„ã„‘ã„’ã„“ã„”ã„•ã„–ã„—ã„˜ã„™".split("");
        const FINALS = "ã„§ã„¨ã„©ã„šã„›ã„œã„ã„ã„Ÿã„ ã„¡ã„¢ã„£ã„¤ã„¥ã„¦".split("");
        const TONES = [" ", "ËŠ", "Ë‡", "Ë‹", "Ë™"];
        const isTone = (char) => TONES.includes(char);
        
        const createShuffledDeck = (length) => {
            const array = Array.from({length}, (_, i) => i);
            for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
            return array;
        };

        // 1. FOOD STREET
        const FoodGame = ({ onBack, playSound, onUpdateHighScore }) => {
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60); 
            const [isGameOver, setIsGameOver] = useState(false);
            const [currentOrder, setCurrentOrder] = useState(null);
            const [step, setStep] = useState(0);
            const [options, setOptions] = useState([]);
            const [questionDeck, setQuestionDeck] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [wrongSide, setWrongSide] = useState(null);

            useEffect(() => {
                const newDeck = createShuffledDeck(FOOD_ITEMS.length);
                nextOrder(newDeck);
                
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleGameOver();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const handleGameOver = () => {
                setIsGameOver(true);
                playSound('win');
            };

            const nextOrder = (overrideDeck = null) => {
                let currentDeck = overrideDeck || [...questionDeck];
                if (currentDeck.length === 0) currentDeck = createShuffledDeck(FOOD_ITEMS.length);
                const nextIndex = currentDeck.pop();
                setQuestionDeck(currentDeck);
                const item = FOOD_ITEMS[nextIndex];
                setCurrentOrder(item);
                setStep(0);
                generateOptionsForStep(item, 0);
            };

            const generateOptionsForStep = (item, stepIndex) => {
                const correctChar = item.zhuyin[stepIndex];
                let distractor = "";
                const useSmartDistractor = Math.random() < 0.6;
                if (useSmartDistractor && CONFUSION_MAP[correctChar]) {
                    const pool = CONFUSION_MAP[correctChar]; distractor = pool[Math.floor(Math.random() * pool.length)];
                } else {
                    if (isTone(correctChar)) { do { distractor = TONES[Math.floor(Math.random() * TONES.length)]; } while (distractor === correctChar); }
                    else if (INITIALS.includes(correctChar)) { do { distractor = INITIALS[Math.floor(Math.random() * INITIALS.length)]; } while (distractor === correctChar); }
                    else { do { distractor = FINALS[Math.floor(Math.random() * FINALS.length)]; } while (distractor === correctChar); }
                }
                setOptions(Math.random() > 0.5 ? [correctChar, distractor] : [distractor, correctChar]);
            };

            const handleOptionClick = (char, side) => {
                if (feedback || isGameOver) return;
                const correctChar = currentOrder.zhuyin[step];
                if (char === correctChar) {
                    playSound('correct');
                    if (step + 1 >= currentOrder.zhuyin.length) {
                        setStep(prev => prev + 1); setFeedback('correct'); setScore(prev => prev + 10);
                        setTimeout(() => { setFeedback(null); nextOrder(); }, 800);
                    } else {
                        setStep(prev => prev + 1); generateOptionsForStep(currentOrder, step + 1);
                    }
                } else {
                    playSound('wrong'); setWrongSide(side); setTimeout(() => setWrongSide(null), 500);
                }
            };

            const AnswerBuilder = () => {
                if (!currentOrder) return null;
                const bodyChars = currentOrder.zhuyin.filter(c => !isTone(c));
                const toneChar = currentOrder.zhuyin.find(c => isTone(c));
                return (
                    <div className="flex flex-col items-center mx-2 scale-125">
                        {toneChar === 'Ë™' && ( <div className="h-8 mb-1"> {currentOrder.zhuyin.indexOf(toneChar) < step ? <span className="text-4xl font-bold text-yellow-400 zhuyin-font">Ë™</span> : (currentOrder.zhuyin.indexOf(toneChar) === step ? <span className="text-4xl font-bold text-red-400 animate-pulse">?</span> : null) } </div> )}
                        <div className="relative flex flex-col items-center">
                            {bodyChars.map((c, i) => ( 
                                <div key={i} className={`w-16 h-16 flex items-center justify-center my-1 relative ${i < step ? 'bg-yellow-400 text-black rounded-lg' : (i === step ? 'border-4 border-red-500 bg-red-900/30 text-red-400 rounded-lg animate-pulse' : 'border-4 border-dashed border-gray-600 rounded-lg')}`}> 
                                    <span className="text-5xl font-black zhuyin-font"> {i < step ? c : (i === step ? "?" : "")} </span> 
                                    {toneChar && toneChar !== 'Ë™' && i === bodyChars.length - 1 && (
                                        <div className="absolute top-0 -right-16">
                                            {currentOrder.zhuyin.indexOf(toneChar) < step ? 
                                                <span className="text-6xl font-bold text-yellow-400 zhuyin-font">{toneChar}</span> : 
                                                (currentOrder.zhuyin.indexOf(toneChar) === step ? <span className="text-6xl font-bold text-red-400 animate-pulse">?</span> : null)
                                            }
                                        </div>
                                    )}
                                </div> 
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full night-market-bg">
                    <div className="flex justify-between items-center p-4 md:px-8 z-10">
                        <button onClick={() => { playSound('click'); onBack(); }} className="bg-white/10 hover:bg-white/20 backdrop-blur px-6 py-2 rounded-full text-lg border border-white/20">â¬… å›å¤œå¸‚</button>
                        <div className="flex gap-8 bg-black/40 px-8 py-2 rounded-full border border-white/10">
                            <div className={`text-3xl font-black font-mono flex items-center gap-2 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-white'}`}> <span>â°</span> {timeLeft} </div>
                            <div className="text-3xl font-black neon-text-yellow flex items-center gap-2"> <span>ğŸ’°</span> {score} </div>
                        </div>
                        <div className="w-20"></div>
                    </div>
                    {isGameOver && <GameOverModal score={score} onRestart={() => { onUpdateHighScore(score); onBack(); }} />}
                    <div className="flex-1 flex flex-row items-center justify-between px-8 md:px-20 pb-8 z-10 max-w-7xl mx-auto w-full gap-8">
                        <div className="flex-1 flex justify-start"> 
                            {options.length > 0 && ( 
                                <button onClick={() => handleOptionClick(options[0], 'left')} className={`w-32 h-32 md:w-48 md:h-48 rounded-3xl border-b-8 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center shadow-2xl ${wrongSide === 'left' ? 'bg-red-500 shake' : 'bg-gradient-to-br from-yellow-300 to-yellow-500 hover:scale-105'}`}> 
                                    {/* Updated: Handle plain tone rendering */}
                                    {isTone(options[0]) ? <span className="text-7xl md:text-8xl font-black text-black zhuyin-font">{options[0] === " " ? " " : options[0]}</span> : <ZhuyinBlock charCode={options[0]} size="xl" color="black" />} 
                                </button> 
                            )} 
                        </div>
                        
                        {/* WIDER CARD (max-w-2xl) and flex-nowrap for title */}
                        <div className="flex-1 flex justify-center"> 
                            <div className="relative bg-gray-800/90 backdrop-blur-md p-8 rounded-[2rem] border-4 border-pink-500 w-full max-w-2xl flex flex-col items-center shadow-[0_0_30px_rgba(236,72,153,0.3)] min-h-[400px]"> 
                                {feedback === 'correct' && <div className="absolute z-50 -top-16 text-9xl text-green-400 font-black pop-in drop-shadow-lg">O</div>} 
                                <div className="text-9xl mb-4 animate-bounce filter drop-shadow-lg">{currentOrder?.emoji}</div> 
                                <div className="flex flex-row flex-nowrap justify-center items-end bg-black/40 px-4 py-4 rounded-2xl border border-white/20 gap-1 mb-4 w-full"> 
                                    {currentOrder?.zhuyinTitle.split(" ").map((token, idx) => ( token === "ï¼¿" ? <AnswerBuilder key={idx} /> : <ZhuyinBlock key={idx} charCode={token} size="lg" /> ))} 
                                </div> 
                            </div> 
                        </div>
                        
                        <div className="flex-1 flex justify-end"> 
                            {options.length > 0 && ( 
                                <button onClick={() => handleOptionClick(options[1], 'right')} className={`w-32 h-32 md:w-48 md:h-48 rounded-3xl border-b-8 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center shadow-2xl ${wrongSide === 'right' ? 'bg-red-500 shake' : 'bg-gradient-to-br from-yellow-300 to-yellow-500 hover:scale-105'}`}> 
                                    {/* Updated: Handle plain tone rendering */}
                                    {isTone(options[1]) ? <span className="text-7xl md:text-8xl font-black text-black zhuyin-font">{options[1] === " " ? " " : options[1]}</span> : <ZhuyinBlock charCode={options[1]} size="xl" color="black" />} 
                                </button> 
                            )} 
                        </div>
                    </div>
                </div>
            );
        };

        // 2. GAME STREET
        const GameStreet = ({ onBack, playSound, onUpdateHighScore }) => {
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [isGameOver, setIsGameOver] = useState(false);
            const [target, setTarget] = useState("");
            const [balloons, setBalloons] = useState([]);
            const [feedback, setFeedback] = useState(null);
            
            const CHARS = ["ã„…","ã„†","ã„‡","ã„ˆ","ã„‰","ã„Š","ã„‹","ã„Œ","ã„","ã„","ã„","ã„","ã„‘","ã„’","ã„“","ã„”","ã„•","ã„–","ã„—","ã„˜","ã„™","ã„§","ã„¨","ã„©","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦"];

            useEffect(() => {
                generateRound(true);
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleGameOver();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const handleGameOver = () => {
                setIsGameOver(true);
                playSound('win');
            };

            const generateRound = (isFirst = false) => {
                const newTarget = CHARS[Math.floor(Math.random() * CHARS.length)];
                setTarget(newTarget);
                if (!isFirst) { setTimeout(() => playSound('speak', newTarget), 300); } else { setTimeout(() => playSound('speak', newTarget), 500); }
                const newBalloons = Array.from({length: 9}, (_, i) => ({ id: i, char: i === 4 ? newTarget : CHARS[Math.floor(Math.random() * CHARS.length)], color: ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500'][Math.floor(Math.random()*5)], popped: false }));
                for (let i = newBalloons.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newBalloons[i], newBalloons[j]] = [newBalloons[j], newBalloons[i]]; }
                if (!newBalloons.find(b => b.char === newTarget)) newBalloons[0].char = newTarget;
                setBalloons(newBalloons);
            };

            const handlePop = (balloon) => {
                if (balloon.popped || feedback || isGameOver) return;
                if (balloon.char === target) {
                    playSound('pop'); setBalloons(prev => prev.map(b => b.id === balloon.id ? {...b, popped: true} : b)); setScore(prev => prev + 10);
                    setTimeout(() => generateRound(), 500);
                } else {
                    playSound('wrong'); setFeedback('wrong'); setTimeout(() => setFeedback(null), 500);
                }
            };

            return (
                <div className="flex flex-col h-full night-market-bg">
                    <div className="flex justify-between items-center p-4 md:px-8 z-10">
                        <button onClick={() => { playSound('click'); onBack(); }} className="bg-white/10 hover:bg-white/20 backdrop-blur px-6 py-2 rounded-full text-lg border border-white/20">â¬… å›å¤œå¸‚</button>
                        <div className="flex gap-8 bg-black/40 px-8 py-2 rounded-full border border-white/10">
                            <div className={`text-3xl font-black font-mono flex items-center gap-2 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-white'}`}> <span>â°</span> {timeLeft} </div>
                            <div className="text-3xl font-black neon-text-blue flex items-center gap-2"> <span>ğŸ†</span> {score} </div>
                        </div>
                        <div className="w-20"></div>
                    </div>
                    {isGameOver && <GameOverModal score={score} onRestart={() => { onUpdateHighScore(score); onBack(); }} />}
                    <div className="flex-1 flex flex-row items-center justify-center p-4 gap-16 z-10">
                        <div className="bg-gray-800/80 backdrop-blur p-8 rounded-3xl border-4 border-blue-500 text-center w-64 shadow-[0_0_30px_rgba(59,130,246,0.3)] flex flex-col items-center">
                            <p className="text-gray-400 text-lg mb-4 font-bold">è½éŸ³è¾¨ä½</p>
                            <button onClick={() => playSound('speak', target)} className="w-32 h-32 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-all pulse-ring relative"> <span className="text-6xl">ğŸ”Š</span> </button>
                            <p className="text-blue-300 text-sm mt-4 animate-pulse">é»æ“Šé‡è½</p>
                        </div>
                        <div className="grid grid-cols-3 gap-6 p-6 bg-white/5 rounded-3xl backdrop-blur-sm border border-white/10 relative">
                            {feedback === 'wrong' && <div className="absolute inset-0 z-50 flex items-center justify-center text-9xl text-red-500 font-bold shake" style={{textShadow:'0 0 10px black'}}>X</div>}
                            {balloons.map((b) => ( <div key={b.id} onClick={() => handlePop(b)} className={`w-28 h-28 rounded-full flex items-center justify-center cursor-pointer transition-all relative border-b-4 border-black/20 ${b.popped ? 'opacity-0 scale-150' : `${b.color} shadow-xl active:scale-95 hover:scale-105`}`}> <div className="absolute top-4 right-6 w-4 h-3 bg-white/30 rounded-full transform rotate-45"></div> <ZhuyinBlock charCode={b.char} size="lg" color="white" /> </div> ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. SHOPPING STREET
        const ShoppingStreet = ({ onBack, playSound, onUpdateHighScore }) => {
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [isGameOver, setIsGameOver] = useState(false);
            const [targetItem, setTargetItem] = useState(null);
            const [options, setOptions] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [wrongChoiceIdx, setWrongChoiceIdx] = useState(null);

            useEffect(() => {
                generateRound();
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleGameOver();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const handleGameOver = () => {
                setIsGameOver(true);
                playSound('win');
            };

            const generateRound = () => {
                const target = SHOP_ITEMS[Math.floor(Math.random() * SHOP_ITEMS.length)];
                setTargetItem(target);

                const others = SHOP_ITEMS.filter(i => i.name !== target.name);
                const shuffledOthers = others.sort(() => 0.5 - Math.random());
                const distractors = shuffledOthers.slice(0, 2);
                
                const roundOptions = [target, ...distractors].sort(() => 0.5 - Math.random());
                setOptions(roundOptions);
                setWrongChoiceIdx(null);
            };

            const handleBuy = (item, idx) => {
                if (feedback || isGameOver) return;
                if (item.name === targetItem.name) {
                    playSound('correct'); setFeedback('correct'); setScore(prev => prev + 10);
                    setTimeout(() => { setFeedback(null); generateRound(); }, 1000);
                } else {
                    playSound('wrong'); setWrongChoiceIdx(idx); setTimeout(() => setWrongChoiceIdx(null), 500);
                }
            };

            return (
                <div className="flex flex-col h-full night-market-bg">
                    <div className="flex justify-between items-center p-4 md:px-8 z-10">
                        <button onClick={() => { playSound('click'); onBack(); }} className="bg-white/10 hover:bg-white/20 backdrop-blur px-6 py-2 rounded-full text-lg border border-white/20">â¬… å›å¤œå¸‚</button>
                        <div className="flex gap-8 bg-black/40 px-8 py-2 rounded-full border border-white/10">
                            <div className={`text-3xl font-black font-mono flex items-center gap-2 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-white'}`}> <span>â°</span> {timeLeft} </div>
                            <div className="text-3xl font-black neon-text-green flex items-center gap-2"> <span>ğŸ›ï¸</span> {score} </div>
                        </div>
                        <div className="w-20"></div>
                    </div>

                    {isGameOver && <GameOverModal score={score} onRestart={() => { onUpdateHighScore(score); onBack(); }} />}

                    <div className="flex-1 flex flex-row items-center justify-center p-8 gap-16 z-10">
                        <div className="flex flex-col items-center justify-center flex-1">
                            <div className="relative">
                                <div className="absolute -top-16 -right-16 bg-white text-black px-6 py-4 rounded-3xl rounded-bl-none shadow-xl border-4 border-gray-300 transform -rotate-12 z-20 max-w-[200px]">
                                    <p className="text-xl font-bold">è«‹å•é€™å€‹æ€éº¼æ‹¼ï¼Ÿ</p>
                                </div>
                                <div className="bg-gray-800/80 p-12 rounded-[3rem] border-4 border-green-500 shadow-[0_0_50px_rgba(16,185,129,0.3)] animate-float">
                                    <div className="text-[10rem] filter drop-shadow-2xl">{targetItem?.emoji}</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col gap-6 flex-1 max-w-md">
                            {feedback === 'correct' && <div className="absolute inset-0 z-50 flex items-center justify-center text-9xl text-green-500 font-black pop-in" style={{textShadow:'0 0 10px black'}}>O</div>}
                            
                            {options.map((item, i) => (
                                <button key={i} onClick={() => handleBuy(item, i)}
                                    className={`bg-gray-800/90 backdrop-blur p-4 rounded-2xl border-4 border-white/10 flex items-center justify-center shadow-lg transition-all hover:scale-105 active:scale-95 group
                                    ${wrongChoiceIdx === i ? 'border-red-500 bg-red-900/50 shake' : 'hover:border-green-400 hover:bg-gray-700'}
                                    `}>
                                    <div className="flex gap-4 pointer-events-none">
                                        {item.zhuyin.split(" ").map((token, k) => (
                                            <ZhuyinBlock key={k} charCode={token} size="lg" color="white" />
                                        ))}
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. MAIN MENU
        const MainMenu = ({ onSelectGame, playSound, highScores }) => {
            return (
                <div className="flex flex-col h-full night-market-bg overflow-y-auto">
                    <div className="relative z-10 flex flex-col items-center justify-center min-h-screen p-8">
                        <div className="mb-12 p-6 border-4 border-yellow-400 rounded-3xl bg-black/40 backdrop-blur-md shadow-[0_0_20px_#eab308] text-center max-w-2xl w-full transform hover:scale-105 transition-transform duration-500">
                            <h1 className="text-6xl md:text-7xl font-black text-white neon-text-pink mb-4 tracking-wider">å¤œå¸‚å¤§å†’éšª</h1>
                            <p className="text-2xl md:text-3xl text-yellow-300 font-bold tracking-widest animate-pulse">ä¾†çœ‹çœ‹æ™‚é–“å…§å¯ä»¥å®Œæˆå¤šå°‘æ¢éšªå§ï¼</p>
                        </div>
                        <div className="flex flex-col md:flex-row gap-8 w-full max-w-6xl justify-center items-stretch">
                            <button onClick={() => { playSound('click'); onSelectGame('food'); }} className="flex-1 bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-pink-500 rounded-3xl p-1 hover:scale-105 hover:-translate-y-2 transition-all shadow-2xl group neon-border-pink"> <div className="h-full rounded-[1.3rem] p-6 flex flex-col items-center justify-center gap-4 bg-gray-900/50 backdrop-blur-sm relative"> <div className="absolute top-2 right-2 bg-pink-900 text-pink-200 text-xs px-2 py-1 rounded-full border border-pink-500">æœ€é«˜: {highScores.food}</div> <div className="text-8xl group-hover:rotate-12 transition-transform">ğŸ¥˜</div> <h2 className="text-4xl font-black text-white neon-text-pink">ç¾é£Ÿè¡—</h2> <div className="flex gap-2"><ZhuyinBlock charCode="ã„‡ã„ŸË‡" size="sm"/><ZhuyinBlock charCode="ã„•ËŠ" size="sm"/><ZhuyinBlock charCode="ã„ã„§ã„" size="sm"/></div> <p className="text-gray-400 font-bold">æ³¨éŸ³å¡«ç©ºæŒ‘æˆ°</p> </div> </button>
                            <button onClick={() => { playSound('click'); onSelectGame('game'); }} className="flex-1 bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-blue-500 rounded-3xl p-1 hover:scale-105 hover:-translate-y-2 transition-all shadow-2xl group neon-border-blue"> <div className="h-full rounded-[1.3rem] p-6 flex flex-col items-center justify-center gap-4 bg-gray-900/50 backdrop-blur-sm relative"> <div className="absolute top-2 right-2 bg-blue-900 text-blue-200 text-xs px-2 py-1 rounded-full border border-blue-500">æœ€é«˜: {highScores.game}</div> <div className="text-8xl group-hover:-rotate-12 transition-transform">ğŸˆ</div> <h2 className="text-4xl font-black text-white neon-text-blue">éŠæˆ²è¡—</h2> <div className="flex gap-2"><ZhuyinBlock charCode="ã„§ã„¡ËŠ" size="sm"/><ZhuyinBlock charCode="ã„’ã„§Ë‹" size="sm"/><ZhuyinBlock charCode="ã„ã„§ã„" size="sm"/></div> <p className="text-gray-400 font-bold">è½éŸ³è¾¨ä½å°„æ°£çƒ</p> </div> </button>
                            <button onClick={() => { playSound('click'); onSelectGame('shop'); }} className="flex-1 bg-gradient-to-b from-gray-800 to-gray-900 border-2 border-green-500 rounded-3xl p-1 hover:scale-105 hover:-translate-y-2 transition-all shadow-2xl group neon-border-green"> <div className="h-full rounded-[1.3rem] p-6 flex flex-col items-center justify-center gap-4 bg-gray-900/50 backdrop-blur-sm relative"> <div className="absolute top-2 right-2 bg-green-900 text-green-200 text-xs px-2 py-1 rounded-full border border-green-500">æœ€é«˜: {highScores.shop}</div> <div className="text-8xl group-hover:translate-x-2 transition-transform">ğŸ›ï¸</div> <h2 className="text-4xl font-black text-white neon-text-green">è³¼ç‰©è¡—</h2> <div className="flex gap-2"><ZhuyinBlock charCode="ã„ã„¡Ë‹" size="sm"/><ZhuyinBlock charCode="ã„¨Ë‹" size="sm"/><ZhuyinBlock charCode="ã„ã„§ã„" size="sm"/></div> <p className="text-gray-400 font-bold">å¹«å®¢äººè²·æ¸…å–®</p> </div> </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ROOT ---
        const App = () => {
            const [currentView, setCurrentView] = useState('home');
            const [highScores, setHighScores] = useState({ food: 0, game: 0, shop: 0 });
            const { playSound, isMuted, toggleMute } = useSound();

            const updateHighScore = (game, score) => {
                setHighScores(prev => ({
                    ...prev,
                    [game]: Math.max(prev[game], score)
                }));
            };

            const renderView = () => {
                switch(currentView) {
                    case 'food': return <FoodGame onBack={() => setCurrentView('home')} playSound={playSound} onUpdateHighScore={(s) => updateHighScore('food', s)} />;
                    case 'game': return <GameStreet onBack={() => setCurrentView('home')} playSound={playSound} onUpdateHighScore={(s) => updateHighScore('game', s)} />;
                    case 'shop': return <ShoppingStreet onBack={() => setCurrentView('home')} playSound={playSound} onUpdateHighScore={(s) => updateHighScore('shop', s)} />;
                    default: return <MainMenu onSelectGame={setCurrentView} playSound={playSound} highScores={highScores} />;
                }
            };

            return (
                <div className="h-screen w-screen overflow-hidden bg-black select-none">
                    <button onClick={toggleMute} className="fixed top-4 right-4 z-50 w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-2xl shadow-lg border border-white/30 active:scale-95 transition-all hover:bg-white/30">
                        {isMuted ? 'ğŸ”‡' : 'ğŸ”Š'}
                    </button>
                    {renderView()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
